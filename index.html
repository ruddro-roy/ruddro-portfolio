<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Starlink Constellation - Real-Time Orbital Mechanics</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000;
            color: #00ff88;
            font-family: 'Courier New', monospace;
            overflow: hidden;
        }

        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        #info-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #00ff88;
            padding: 15px;
            border-radius: 5px;
            z-index: 100;
            min-width: 300px;
        }

        #controls-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #00ff88;
            padding: 15px;
            border-radius: 5px;
            z-index: 100;
            min-width: 250px;
        }

        #status-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #00ff88;
            padding: 15px;
            border-radius: 5px;
            z-index: 100;
            min-width: 300px;
        }

        .panel-title {
            color: #00ff88;
            font-weight: bold;
            margin-bottom: 10px;
            border-bottom: 1px solid #00ff88;
            padding-bottom: 5px;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }

        .metric-value {
            color: #ffffff;
        }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #00ff88;
            font-size: 18px;
            z-index: 200;
        }

        .hidden {
            display: none;
        }

        canvas {
            display: block;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="loading">Initializing Starlink Constellation...</div>
        
        <div id="info-panel" class="hidden">
            <div class="panel-title">STARLINK CONSTELLATION</div>
            <div class="metric">
                <span>Total Satellites:</span>
                <span class="metric-value" id="satellite-count">0</span>
            </div>
            <div class="metric">
                <span>Orbital Shells:</span>
                <span class="metric-value" id="shell-count">4</span>
            </div>
            <div class="metric">
                <span>Average Altitude:</span>
                <span class="metric-value" id="avg-altitude">555 km</span>
            </div>
            <div class="metric">
                <span>Orbital Period:</span>
                <span class="metric-value" id="orbital-period">~95.5 min</span>
            </div>
            <div class="metric">
                <span>Velocity:</span>
                <span class="metric-value" id="velocity">~7.66 km/s</span>
            </div>
            <div class="metric">
                <span>Last Update:</span>
                <span class="metric-value" id="last-update">Initializing...</span>
            </div>
        </div>

        <div id="controls-panel" class="hidden">
            <div class="panel-title">CONTROLS</div>
            <div class="metric">
                <span>Mouse:</span>
                <span class="metric-value">Rotate View</span>
            </div>
            <div class="metric">
                <span>Scroll:</span>
                <span class="metric-value">Zoom In/Out</span>
            </div>
            <div class="metric">
                <span>Auto-Rotate:</span>
                <span class="metric-value" id="auto-rotate">Enabled</span>
            </div>
            <div class="metric">
                <span>Update Rate:</span>
                <span class="metric-value">10 seconds</span>
            </div>
        </div>

        <div id="status-panel" class="hidden">
            <div class="panel-title">SYSTEM STATUS</div>
            <div class="metric">
                <span>FPS:</span>
                <span class="metric-value" id="fps">0</span>
            </div>
            <div class="metric">
                <span>Rendered Objects:</span>
                <span class="metric-value" id="rendered-objects">0</span>
            </div>
            <div class="metric">
                <span>Memory Usage:</span>
                <span class="metric-value" id="memory-usage">Calculating...</span>
            </div>
            <div class="metric">
                <span>Connection:</span>
                <span class="metric-value" id="connection-status">Connecting...</span>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script>
        // Constants based on real orbital mechanics
        const EARTH_RADIUS = 6371; // km
        const SCALE = 0.001; // Scale factor for visualization
        
        // Scene setup
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 10000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setClearColor(0x000000);
        document.getElementById('container').appendChild(renderer.domElement);

        // Controls
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.enableZoom = true;
        controls.autoRotate = true;
        controls.autoRotateSpeed = 0.5;

        // Earth
        const earthGeometry = new THREE.SphereGeometry(EARTH_RADIUS * SCALE, 64, 64);
        const earthMaterial = new THREE.MeshBasicMaterial({
            map: new THREE.TextureLoader().load('https://threejs.org/examples/textures/land_ocean_ice_cloud_2048.jpg'),
            transparent: true,
            opacity: 0.9
        });
        const earth = new THREE.Mesh(earthGeometry, earthMaterial);
        scene.add(earth);

        // Starlink satellites container
        const satelliteGroup = new THREE.Group();
        scene.add(satelliteGroup);

        // Satellite geometry (shared for performance) - Made much larger for visibility
        const satelliteGeometry = new THREE.SphereGeometry(50 * SCALE, 8, 8);
        const satelliteMaterial = new THREE.MeshBasicMaterial({ 
            color: 0x00ff88,
            transparent: true,
            opacity: 0.9
        });

        // Performance tracking
        let frameCount = 0;
        let lastTime = performance.now();
        let satellites = [];

        // Position camera
        camera.position.set(0, 0, EARTH_RADIUS * SCALE * 3);
        camera.lookAt(0, 0, 0);

        // Convert lat/lon/alt to Cartesian coordinates
        function geodeticToCartesian(lat, lon, alt) {
            const phi = lat * Math.PI / 180;
            const lambda = lon * Math.PI / 180;
            const r = (EARTH_RADIUS + alt) * SCALE;
            
            const x = r * Math.cos(phi) * Math.cos(lambda);
            const y = r * Math.cos(phi) * Math.sin(lambda);
            const z = r * Math.sin(phi);
            
            return { x, y, z };
        }

        // Create satellite mesh
        function createSatellite() {
            return new THREE.Mesh(satelliteGeometry, satelliteMaterial);
        }

        // Update satellite positions
        async function updateSatellites() {
            try {
                document.getElementById('connection-status').textContent = 'Fetching...';
                
                const response = await fetch('/api/starlink/positions');
                const data = await response.json();
                
                if (!data.satellites) {
                    throw new Error('No satellite data received');
                }

                // Clear existing satellites
                satelliteGroup.clear();
                satellites = [];

                // Add satellites to scene (limit to 1000 for better performance and visibility)
                data.satellites.slice(0, 1000).forEach((satData, index) => {
                    const satellite = createSatellite();
                    const pos = geodeticToCartesian(satData.lat, satData.lon, satData.alt);
                    satellite.position.set(pos.x, pos.y, pos.z);
                    satelliteGroup.add(satellite);
                    satellites.push(satellite);
                });

                // Update UI
                document.getElementById('satellite-count').textContent = data.satellites.length;
                document.getElementById('last-update').textContent = new Date(data.timestamp).toLocaleTimeString();
                document.getElementById('connection-status').textContent = 'Connected';
                document.getElementById('rendered-objects').textContent = data.satellites.length + 1; // +1 for Earth

                console.log(`Updated ${data.satellites.length} Starlink satellites`);
                
            } catch (error) {
                console.error('Failed to update satellites:', error);
                document.getElementById('connection-status').textContent = 'Error';
            }
        }

        // Animation loop
        function animate() {
            requestAnimationFrame(animate);
            
            // Update controls
            controls.update();
            
            // Rotate Earth
            earth.rotation.y += 0.001;
            
            // Update FPS
            frameCount++;
            const currentTime = performance.now();
            if (currentTime - lastTime >= 1000) {
                const fps = Math.round((frameCount * 1000) / (currentTime - lastTime));
                document.getElementById('fps').textContent = fps;
                frameCount = 0;
                lastTime = currentTime;
            }
            
            // Render scene
            renderer.render(scene, camera);
        }

        // Initialize
        async function initialize() {
            try {
                // Hide loading screen
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('info-panel').classList.remove('hidden');
                document.getElementById('controls-panel').classList.remove('hidden');
                document.getElementById('status-panel').classList.remove('hidden');
                
                // Initial satellite update
                await updateSatellites();
                
                // Start animation
                animate();
                
                // Set up periodic updates (every 10 seconds)
                setInterval(updateSatellites, 10000);
                
                console.log('Starlink Constellation Simulator initialized successfully');
                
            } catch (error) {
                console.error('Initialization failed:', error);
                document.getElementById('loading').textContent = 'Initialization failed. Please refresh.';
            }
        }

        // Handle window resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // Start the simulation
        initialize();
    </script>
</body>
</html>

